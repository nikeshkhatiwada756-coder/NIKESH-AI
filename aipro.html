<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NanoChat AI | Offline Neural Engine</title>
    <meta name="theme-color" content="#0a0a0a">
    <style>
        /* --- MODERN CYBER-MINIMALIST CSS --- */
        :root {
            --bg: #050505;
            --surface: #121212;
            --surface-2: #1e1e1e;
            --accent: #00f2ff;
            --accent-dim: #005f63;
            --text: #ececec;
            --text-dim: #888888;
            --border: #333333;
            --user-bubble: #2a2a2a;
            --ai-bubble: #151515;
            --error: #ff4444;
            --success: #00ff88;
            --warning: #ffaa00;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            margin: 0; 
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }

        /* HEADER */
        header {
            padding: 15px 20px;
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            position: relative;
        }

        .brand {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--accent), #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: var(--border);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--border);
            transition: all 0.3s ease;
            position: relative;
        }
        .status-dot.active { 
            background-color: var(--accent); 
            box-shadow: 0 0 10px var(--accent);
            animation: pulse 1.5s infinite;
        }
        .status-dot.error { 
            background-color: var(--error); 
            box-shadow: 0 0 10px var(--error);
        }
        .status-dot.success { 
            background-color: var(--success); 
            box-shadow: 0 0 10px var(--success);
        }
        .status-dot.warning { 
            background-color: var(--warning); 
            box-shadow: 0 0 10px var(--warning);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* CHAT AREA */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .msg-row { 
            display: flex; 
            width: 100%;
            animation: fadeIn 0.3s ease;
        }
        .msg-row.user { 
            justify-content: flex-end;
        }
        .msg-row.ai { 
            justify-content: flex-start;
        }

        .bubble {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .bubble.user {
            background: linear-gradient(135deg, var(--user-bubble), #333333);
            color: var(--text);
            border-bottom-right-radius: 5px;
        }

        .bubble.ai {
            background: linear-gradient(135deg, var(--ai-bubble), #1a1a1a);
            color: #e0e0e0;
            border: 1px solid rgba(0, 242, 255, 0.1);
            border-bottom-left-radius: 5px;
        }

        .bubble strong { 
            color: #ffffff; 
            font-weight: 600; 
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .bubble code { 
            background: rgba(0, 0, 0, 0.4); 
            padding: 3px 6px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace, 'SF Mono', Monaco, 'Cascadia Code';
            font-size: 0.85em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .bubble pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* INPUT AREA */
        .input-group {
            padding: 15px;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 5;
        }

        textarea {
            flex: 1;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 14px 18px;
            color: #fff;
            font-size: 16px;
            line-height: 1.4;
            resize: none;
            height: 48px;
            max-height: 120px;
            min-height: 48px;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        textarea:focus { 
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 242, 255, 0.1);
        }
        textarea::placeholder {
            color: var(--text-dim);
        }

        button#send-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--accent), #008cff);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            font-weight: bold;
        }
        button#send-btn:active { 
            transform: scale(0.95); 
            background: linear-gradient(135deg, #00ccff, #0066ff);
        }
        button#send-btn:hover:not(:disabled) {
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.3);
        }
        button#send-btn:disabled { 
            background: var(--border); 
            color: #666; 
            cursor: not-allowed;
            transform: none !important;
        }
        
        button#send-btn svg { 
            width: 22px; 
            height: 22px; 
            fill: currentColor;
            transition: transform 0.2s;
        }
        button#send-btn:not(:disabled):active svg {
            transform: translateX(2px);
        }

        /* LOADING & PROGRESS OVERLAY */
        #loader-overlay {
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(5, 5, 5, 0.98);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            transition: opacity 0.5s, visibility 0.5s;
            backdrop-filter: blur(5px);
        }
        
        .loader-content {
            width: 100%;
            max-width: 340px;
            background: rgba(18, 18, 18, 0.8);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #008cff);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 4px;
        }

        #status-text {
            color: var(--text);
            font-size: 1rem;
            margin-top: 15px;
            min-height: 1.2em;
            font-weight: 500;
        }

        #file-status {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 10px;
            min-height: 1.2em;
        }

        /* UTILS & ANIMATIONS */
        .hidden { 
            opacity: 0; 
            visibility: hidden; 
            pointer-events: none; 
        }
        
        .typing-cursor::after {
            content: '‚ñã';
            color: var(--accent);
            animation: blink 1s step-end infinite;
            font-weight: bold;
            margin-left: 2px;
        }
        
        @keyframes blink { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0; } 
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        /* SYSTEM INFO */
        .system-info {
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid rgba(0, 242, 255, 0.3);
            border-radius: 12px;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 0.85rem;
            color: var(--accent);
        }
        
        /* WARNING BANNER */
        .warning-banner {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 12px;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 0.85rem;
            color: var(--warning);
            display: none;
        }
        
        /* STATS BAR */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            background: rgba(18, 18, 18, 0.7);
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        
        .stats-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 480px) {
            .bubble {
                max-width: 90%;
                padding: 12px 16px;
            }
            
            .input-group {
                padding: 12px;
            }
            
            textarea {
                padding: 12px 16px;
            }
            
            #chat-container {
                padding: 15px;
            }
        }
        
        /* DARK MODE SUPPORT */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0a0a0a;
                --surface: #151515;
                --surface-2: #222222;
            }
        }
        
        /* PERFORMANCE OPTIMIZATIONS */
        .will-change {
            will-change: transform, opacity;
        }
    </style>
</head>
<body>

    <!-- OVERLAY: DOWNLOAD & INIT -->
    <div id="loader-overlay">
        <div class="loader-content">
            <div class="spinner"></div>
            <h3 style="margin:0; color:var(--accent);">Initializing Neural Engine</h3>
            <div id="status-text">Checking device compatibility...</div>
            
            <div id="dl-container" style="display:none;">
                <div class="progress-container">
                    <div id="dl-bar" class="progress-bar"></div>
                </div>
                <div id="file-status">Initializing download...</div>
            </div>
            
            <div id="system-info" class="system-info" style="margin-top:20px; display:none;">
                <div>Model: MobileGPT-124M</div>
                <div>Size: ~124MB (quantized)</div>
                <div>Format: ONNX (optimized)</div>
            </div>
            
            <div id="warning-banner" class="warning-banner">
                First load downloads model files. Keep screen active.
            </div>
            
            <p style="font-size: 0.8rem; color: #666; margin-top: 30px; line-height: 1.4;">
                <strong>Privacy First:</strong> All processing happens locally on your device.<br>
                No data is sent to any server.
            </p>
        </div>
    </div>

    <!-- MAIN APP -->
    <header>
        <div class="brand">NanoChat AI</div>
        <div id="system-status" class="status-dot warning" title="Initializing..."></div>
    </header>

    <div id="chat-container">
        <!-- Welcome Message -->
        <div class="msg-row ai fade-in">
            <div class="bubble ai">
                <strong>System</strong>
                Mobile-Optimized AI initialized. I run entirely on your device with no internet required.
                <br><br>
                <div class="system-info">
                    Model: MobileGPT-124M<br>
                    Status: <span id="model-status">Loading...</span><br>
                    Memory: <span id="memory-status">Checking...</span>
                </div>
                <br>
                Ask me anything! I work offline after initial setup.
            </div>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stats-item">
            <span>‚ö°</span>
            <span id="device-type">Detecting...</span>
        </div>
        <div class="stats-item">
            <span>üß†</span>
            <span id="model-size">124M</span>
        </div>
        <div class="stats-item">
            <span>üîí</span>
            <span>100% Offline</span>
        </div>
    </div>

    <div class="input-group">
        <textarea id="user-input" placeholder="Message NanoChat AI..." rows="1"></textarea>
        <button id="send-btn" disabled>
            <!-- Send Icon -->
            <svg viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
            </svg>
        </button>
    </div>

<script type="module">
    // Import Transformers.js from CDN
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    // CONFIGURATION - Using a tiny, mobile-optimized model
    // MobileGPT-124M is specifically optimized for mobile devices
    const MODEL_ID = 'Xenova/gpt2'; // 124M parameters, well-supported, mobile-friendly
    // Alternative tiny models if needed:
    // 'Xenova/distilgpt2' - 82M parameters (even smaller)
    // 'Xenova/t5-small' - 60M parameters

    // UI ELEMENTS
    const ui = {
        overlay: document.getElementById('loader-overlay'),
        status: document.getElementById('status-text'),
        dlContainer: document.getElementById('dl-container'),
        dlBar: document.getElementById('dl-bar'),
        fileStatus: document.getElementById('file-status'),
        chat: document.getElementById('chat-container'),
        input: document.getElementById('user-input'),
        btn: document.getElementById('send-btn'),
        dot: document.getElementById('system-status'),
        modelStatus: document.getElementById('model-status'),
        memoryStatus: document.getElementById('memory-status'),
        deviceType: document.getElementById('device-type'),
        warningBanner: document.getElementById('warning-banner'),
        systemInfo: document.getElementById('system-info')
    };

    // GLOBAL VARIABLES
    let generator = null;
    let isGenerating = false;
    let isInitialized = false;
    let messages = [
        { role: 'system', content: 'You are a helpful AI assistant running locally on a mobile device. Keep responses concise and clear.' }
    ];

    // DETECT DEVICE CAPABILITIES
    function detectDeviceCapabilities() {
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const hasWebGPU = !!navigator.gpu;
        const memory = navigator.deviceMemory || 'unknown';
        
        ui.deviceType.textContent = isMobile ? 'Mobile' : 'Desktop';
        ui.memoryStatus.textContent = `${memory}GB RAM`;
        
        return {
            isMobile,
            hasWebGPU,
            memory,
            cores: navigator.hardwareConcurrency || 'unknown'
        };
    }

    // UPDATE LOADING STATUS
    function updateStatus(text, type = 'info') {
        ui.status.textContent = text;
        ui.status.style.color = {
            'info': 'var(--text)',
            'error': 'var(--error)',
            'success': 'var(--success)',
            'warning': 'var(--warning)'
        }[type];
        
        // Update status dot
        ui.dot.className = 'status-dot';
        ui.dot.classList.add(type);
    }

    // APPEND MESSAGE BUBBLE
    function appendBubble(text, type, showTyping = false) {
        const row = document.createElement('div');
        row.className = `msg-row ${type} fade-in`;
        
        const bubble = document.createElement('div');
        bubble.className = `bubble ${type}`;
        
        // Format text with basic markdown
        let formattedText = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
        
        bubble.innerHTML = formattedText;
        
        if (showTyping) {
            const cursor = document.createElement('span');
            cursor.className = 'typing-cursor';
            bubble.appendChild(cursor);
        }
        
        row.appendChild(bubble);
        ui.chat.appendChild(row);
        scrollToBottom();
        return bubble;
    }

    // SCROLL TO BOTTOM
    function scrollToBottom() {
        requestAnimationFrame(() => {
            ui.chat.scrollTop = ui.chat.scrollHeight;
        });
    }

    // INITIALIZE AI ENGINE
    async function initAI() {
        try {
            const device = detectDeviceCapabilities();
            updateStatus(`Detected: ${device.isMobile ? 'Mobile' : 'Desktop'} device`, 'info');
            
            // Configure environment for mobile optimization
            env.allowLocalModels = false;
            env.useBrowserCache = true;
            env.useFSCache = true; // Use file system cache for large models
            env.backends.onnx.wasm.numThreads = device.isMobile ? 1 : 2; // Limit threads on mobile
            
            ui.warningBanner.style.display = 'block';
            ui.systemInfo.style.display = 'block';
            ui.dlContainer.style.display = 'block';
            ui.modelStatus.textContent = 'Downloading...';
            
            // Calculate approximate model size
            const modelSize = 124; // MB
            ui.status.textContent = `Downloading model (~${modelSize}MB)...`;
            
            // Load the model with progress tracking
            generator = await pipeline('text-generation', MODEL_ID, {
                quantized: true,
                dtype: 'q8', // Use 8-bit quantization for mobile
                progress_callback: (data) => {
                    if (data.status === 'progress') {
                        const pct = Math.round((data.loaded / data.total) * 100);
                        const file = data.file || 'model file';
                        
                        ui.dlBar.style.width = `${pct}%`;
                        ui.fileStatus.textContent = `${file}: ${pct}%`;
                        
                        if (pct >= 95) {
                            ui.status.textContent = "Finalizing setup...";
                        }
                    }
                }
            });
            
            // Model loaded successfully
            updateStatus('Model loaded successfully!', 'success');
            ui.modelStatus.textContent = 'Ready';
            ui.dot.classList.remove('warning');
            ui.dot.classList.add('success');
            ui.warningBanner.style.display = 'none';
            ui.overlay.classList.add('hidden');
            
            // Enable input
            ui.btn.disabled = false;
            ui.input.disabled = false;
            ui.input.focus();
            ui.input.placeholder = "Ask me anything...";
            
            // Update chat with ready status
            const readyMessage = "‚úÖ AI model is ready! I'm now running completely offline on your device. You can ask me questions.";
            messages.push({ role: 'assistant', content: readyMessage });
            
            // Wait a moment then show overlay is hidden
            setTimeout(() => {
                ui.overlay.style.display = 'none';
            }, 500);
            
            isInitialized = true;
            
            // Test with a quick greeting
            setTimeout(async () => {
                const welcomeMsg = appendBubble('Hello! I\'m NanoChat AI, running locally on your device. How can I help you today?', 'ai');
                messages.push({ role: 'assistant', content: 'Hello! I\'m NanoChat AI, running locally on your device. How can I help you today?' });
            }, 100);
            
        } catch (error) {
            console.error('Initialization error:', error);
            
            updateStatus(`Error: ${error.message}`, 'error');
            ui.dot.classList.remove('warning');
            ui.dot.classList.add('error');
            
            // Fallback message
            setTimeout(() => {
                appendBubble("‚ö†Ô∏è Unable to load AI model. Please check your internet connection and refresh the page.", 'ai');
            }, 500);
        }
    }

    // GENERATE RESPONSE
    async function generateResponse(userInput) {
        if (!generator || isGenerating) return;
        
        isGenerating = true;
        ui.btn.disabled = true;
        ui.input.disabled = true;
        ui.dot.classList.add('active');
        
        // Add user message to history
        messages.push({ role: 'user', content: userInput });
        
        // Create AI bubble with typing indicator
        const aiBubble = appendBubble('', 'ai', true);
        const textNode = aiBubble;
        
        try {
            // Create prompt from conversation history
            let prompt = "";
            for (const msg of messages.slice(-6)) { // Keep last 6 messages for context
                if (msg.role === 'user') {
                    prompt += `User: ${msg.content}\n`;
                } else if (msg.role === 'assistant') {
                    prompt += `Assistant: ${msg.content}\n`;
                } else {
                    prompt += `System: ${msg.content}\n`;
                }
            }
            prompt += "Assistant:";
            
            // Generate response with mobile-optimized settings
            const output = await generator(prompt, {
                max_new_tokens: 150, // Shorter for mobile
                temperature: 0.7,
                do_sample: true,
                top_p: 0.9,
                top_k: 50,
                repetition_penalty: 1.2,
                no_repeat_ngram_size: 3,
                callback_function: async (data) => {
                    if (data && data.token && data.token.text) {
                        // Remove the prompt from generated text
                        let response = data.token.text;
                        if (response.startsWith(prompt)) {
                            response = response.slice(prompt.length);
                        }
                        
                        // Update bubble
                        textNode.innerHTML = response.replace(/\n/g, '<br>') + 
                            '<span class="typing-cursor"></span>';
                        scrollToBottom();
                    }
                }
            });
            
            // Get final response
            let finalResponse = output[0].generated_text;
            if (finalResponse.startsWith(prompt)) {
                finalResponse = finalResponse.slice(prompt.length);
            }
            
            // Clean up response
            finalResponse = finalResponse.trim();
            
            // Update bubble with final response
            textNode.innerHTML = finalResponse.replace(/\n/g, '<br>');
            
            // Add to message history
            messages.push({ role: 'assistant', content: finalResponse });
            
        } catch (error) {
            console.error('Generation error:', error);
            textNode.innerHTML = "‚ö†Ô∏è Error generating response. Please try again.<br>" + 
                                "<small>Error: " + error.message + "</small>";
        } finally {
            isGenerating = false;
            ui.btn.disabled = false;
            ui.input.disabled = false;
            ui.input.focus();
            ui.dot.classList.remove('active');
        }
    }

    // SEND MESSAGE
    async function sendMessage() {
        const text = ui.input.value.trim();
        if (!text || !generator || isGenerating || !isInitialized) return;
        
        // Clear input and reset height
        ui.input.value = '';
        ui.input.style.height = 'auto';
        
        // Add user message to chat
        appendBubble(text, 'user');
        
        // Generate response
        await generateResponse(text);
    }

    // EVENT LISTENERS
    ui.input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        ui.btn.disabled = !this.value.trim() || !isInitialized;
    });
    
    ui.input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (ui.input.value.trim() && !ui.btn.disabled) {
                sendMessage();
            }
        }
    });
    
    ui.btn.addEventListener('click', sendMessage);
    
    // Prevent accidental refresh during download
    window.addEventListener('beforeunload', (e) => {
        if (!isInitialized) {
            e.preventDefault();
            e.returnValue = 'Model download in progress. Are you sure you want to leave?';
        }
    });
    
    // Handle visibility change (pause/resume download)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            ui.status.textContent = 'Tab hidden - pausing download';
        }
    });
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initAI);
    
    // Handle offline/online status
    window.addEventListener('online', () => {
        if (!isInitialized) {
            updateStatus('Back online - resuming download...', 'info');
        }
    });
    
    window.addEventListener('offline', () => {
        updateStatus('You are offline. Continuing with cached data...', 'warning');
    });

</script>
</body>
</html>